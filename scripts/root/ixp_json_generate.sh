#!/bin/bash
# NOTE(bryce): Originally written by Chris, added to git by Bryce Wilson on 2020-09-13.
#  * 2020-11-28|>Bryce|>Cleaned up a bit
#  * 2020-11-29|>Bryce|>Added printing of result for debugging
#  * 2021-02-19|>Bryce|>Move to JQ based system

mysql --user evix --password=***REMOVED*** --reconnect evix --batch -N 2>/dev/null <<<"SELECT json_arrayagg(json_object('id', id, 'name', name, 'website', website, 'contact', contact, 'tunnels', (SELECT json_arrayagg(json_object('id', id, 'type', type, 'server', server, 'tunnel_id', tunnel_id, 'ip', ip, 'additional_args', additional_args)) FROM connections WHERE client_id=clients.id), 'asns', (SELECT json_arrayagg(json_object('asn', asn, 'ips', (SELECT json_arrayagg(json_object('ip', ip, 'version', version, 'monitor', monitor, 'provisioned', provisioned, 'pingable', pingable, 'rs_session', birdable)) FROM ips WHERE ips.asn=asns.asn))) FROM asns WHERE client_id=clients.id))) FROM clients;" |
jq --compact-output 'map(select(.asns | length > 0)) | map((. + {asn: .asns[]}) | del(.asns)) | map({asnum: .asn.asn, member_type: "peering", name: .name, url: .website, peering_policy: (if [.asn.ips[].monitor] | any(. == 1) then "open" else "selective" end), contact_email: [.contact], connection_list: [{ixp_id: 756, state: (if [.asn.ips[].rs_session] | all(. == 1) then "active" else "connecting" end), if_list: [.tunnels // [] | .[] | {switch_id: (if .server == "fmt" then 0 elif .server == "ams" then 1 elif .server == "zur" then 2 elif .server == "nz" then 3 elif .server == "van" then 4 elif .server == "fra" then 5 else 100 end), if_speed: 1000, if_type: .type}], vlan_list: [(.asn.ips // [] | map(select(.version == 4)) | .[] | {vlan_id: 0, ipv4: {address: .ip, max_prefix: 100, routeserver: (.monitor == 1)}}), (.asn.ips // [] | map(select(.version == 6)) | .[] | {vlan_id: 0, ipv6: {address: .ip, max_prefix: 100, routeserver: (.monitor == 1)}})]}]}) | . + [{"asnum":209762,"member_type":"ixp","name":"Backup Route Server","url":"https://evix.org","peering_policy":"open","peering_policy_url":"https://evix.org/#faq","contact_email":["helpdesk@evix.org"],"contact_hours":"Whenever our volunteers have time. Please be patient.","connection_list":[{"ixp_id":756,"state":"active","if_list":[{"switch_id":0,"if_speed":1000}],"vlan_list":[{"vlan_id":0,"ipv4":{"address":"206.81.104.253","routeserver":true,"as_macro":"AS-EVIX","max_prefix":1000000,"services":[{"type":"ixrouteserver","os":"Ubuntu","os_version":"20.04","deamon":"bird","daemon_version":"1.6.4"}]},"ipv6":{"address":"2602:fed2:fff:ffff::253","routeserver":true,"as_macro":"AS-EVIX","max_prefix":1000000,"services":[{"type":"ixrouteserver","os":"Ubuntu","os_version":"20.04","deamon":"bird","daemon_version":"1.6.4"}]}}]}]},{"asnum":137933,"member_type":"ixp","name":"Route Server","url":"https://evix.org","peering_policy":"open","peering_policy_url":"https://evix.org/#faq","contact_email":["helpdesk@evix.org"],"contact_hours":"Whenever our volunteers have time. Please be patient.","connection_list":[{"ixp_id":756,"state":"active","if_list":[{"switch_id":1,"if_speed":1000}],"vlan_list":[{"vlan_id":0,"ipv4":{"address":"206.81.104.1","routeserver":true,"as_macro":"AS-EVIX","max_prefix":1000000,"services":[{"type":"ixrouteserver","os":"Ubuntu","os_version":"20.04","deamon":"bird","daemon_version":"1.6.4"}]},"ipv6":{"address":"2602:fed2:fff:ffff::1","routeserver":true,"as_macro":"AS-EVIX","max_prefix":1000000,"services":[{"type":"ixrouteserver","os":"Ubuntu","os_version":"20.04","deamon":"bird","daemon_version":"1.6.4"}]}}]}]}] | {version: "1.0", timestamp: (now | todateiso8601), ixp_list: [{ixp_id: 756, shortname: "EVIX", name: "Experimental Virtual Internet Exchange", url: "https://evix.org/", country: "CA", ixf_id: 756, support_email: "helpdesk@evix.org", support_contact_hours: "Whenever our volunteers have time. Do not expect speedy responses.", peering_policy_list: ["open", "selective"], vlan: [{id: 0, name: "Peering VLAN", ipv4: {prefix: "206.81.104.0", masklen: 24, looking_glass_urls: ["https://lg.evix.org/alice/routeservers/0", "https://lg.evix.org/alice/routeservers/2"]}, ipv6:{prefix: "2602:fed2:fff:ffff::", masklen: 64, looking_glass_urls: ["https://lg.evix.org/alice/routeservers/1", "https://lg.evix.org/alice/routeservers/3"]}}], switch: [{id: 0, name: "Fremont, CA, United States", pdb_facility_id: 547, city: "Fremont", country: "US", software: "Ubuntu"}, {id: 1, name: "Amsterdam, The Netherlands", pdb_facility_id: 857, city: "Dronten", country: "NL", software: "Ubuntu"}, {id: 2, name: "Zurich, Switzerland", city: "Zurich", country: "CZ", software: "Ubuntu"}, {id: 3, name: "Auckland, New Zealand", city: "Auckland", country: "NZ", software: "Ubuntu"}, {id: 4, name: "Vancouver, BC, Canada", city: "Vancouver", country: "CA", software: "Ubuntu"}, {id: 5, name: "Frankfurt, Germany", city: "Frankfurt", country: "DE", software: "Ubuntu"}]}], member_list: .}' |
tee /var/www/evix/participants.json | jq -C '.'
